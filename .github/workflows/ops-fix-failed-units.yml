name: "OPS - Fix Failed Units (Cleanup)"

on:
  workflow_dispatch:
    inputs:
      runner:
        description: "Target runner label"
        required: true
        default: "sg-arm"
        type: choice
        options:
          - sg-arm
          - sg-x86
      unit_name:
        description: "Systemd unit name to remove/disable"
        required: true
        default: "wp-backup-nzfreeman.service"
        type: string

jobs:
  fix_failed_unit:
    runs-on: [self-hosted, "${{ inputs.runner }}"]
    steps:
      - name: Show context
        run: |
          set -euxo pipefail
          whoami
          hostname
          systemctl --no-pager --failed || true

      - name: Disable + remove unit (idempotent)
        run: |
          set -euxo pipefail
          UNIT="${{ inputs.unit_name }}"

          # Disable/stop even if it's already gone
          sudo -n systemctl disable --now "$UNIT" || true

          # Remove common unit locations
          sudo -n rm -f "/etc/systemd/system/$UNIT" "/lib/systemd/system/$UNIT" "/usr/lib/systemd/system/$UNIT" || true

          # Reload and clear failed state
          sudo -n systemctl daemon-reload
          sudo -n systemctl reset-failed

          # Verify
          systemctl --no-pager --failed || true
